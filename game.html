<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emory</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f9f9f9;
    }
    .container {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .profile-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #f0f8ff;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #4CAF50;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-right: 10px;
    }
    .total-score {
      font-weight: bold;
      color: #E65100;
      font-size: 18px;
    }
    .emoji-container {
      font-size: 24px;
      background-color: #f0f8ff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      min-height: 40px;
      text-align: center;
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      resize: vertical;
    }
    .result-box {
      background-color: #f0fff0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      min-height: 100px;
    }
    .button-group {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background-color 0.3s;
    }
    .start-btn {
      background-color: #4CAF50;
      color: white;
    }
    .submit-btn {
      background-color: #2196F3;
      color: white;
    }
    .save-btn {
      background-color: #9C27B0;
      color: white;
    }
    button:hover {
      opacity: 0.9;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .leaderboard {
      margin-top: 30px;
    }
    .leaderboard h2 {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
      color: #333;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .score {
      font-weight: bold;
      color: #E65100;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 10px 0;
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .api-key-container {
      margin-bottom: 20px;
    }
    .api-key-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    .tab-container {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: 5px 5px 0 0;
    }
    .tab.active {
      border: 1px solid #ddd;
      border-bottom: none;
      background-color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .nickname-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      width: 300px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal-content h2 {
      margin-top: 0;
      color: #333;
    }
    .modal-content input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .modal-content button {
      width: 100%;
      margin-top: 10px;
    }
    .medal {
      font-size: 20px;
      margin-right: 5px;
    }
    .recent-games {
      margin-top: 20px;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
    }
    .recent-games h3 {
      margin-top: 0;
      color: #333;
    }
    .game-history {
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .game-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
    }
    .game-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Emory</h1>
      <p>ì´ëª¨í‹°ì½˜ì„ í™œìš©í•˜ì—¬ ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ì‘ì„±í•˜ê³  AIì—ê²Œ í‰ê°€ë°›ì•„ë³´ì„¸ìš”!</p>
    </div>
    
    <!-- API í‚¤ê°€ ì½”ë“œì— ì§ì ‘ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤ -->
    <div class="api-key-container" style="display: none;">
      <input type="password" id="apiKeyInput" class="api-key-input" value="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" />
    </div>
    
    <!-- í”„ë¡œí•„ ì„¹ì…˜ -->
    <div class="profile-section">
      <div class="user-info">
        <div class="avatar" id="avatarDisplay">?</div>
        <div>
          <div id="nicknameDisplay">ë¡œê·¸ì¸ í•„ìš”</div>
          <small>ìµœê·¼ ê²Œì„: <span id="gamesCountDisplay">0</span>íšŒ</small>
        </div>
      </div>
      <div class="total-score">
        ì´ì : <span id="totalScoreDisplay">0</span>ì 
      </div>
    </div>
    
    <div class="tab-container">
      <div class="tab active" onclick="openTab('game')">ê²Œì„ í”Œë ˆì´</div>
      <div class="tab" onclick="openTab('leaderboard')">ìˆœìœ„í‘œ</div>
      <div class="tab" onclick="openTab('history')">ë‚´ ê¸°ë¡</div>
    </div>
    
    <div id="game" class="tab-content active">
      <div class="emoji-container" id="emojiDisplay">ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì´ëª¨í‹°ì½˜ì„ ë°›ì•„ë³´ì„¸ìš”</div>
      
      <textarea id="storyInput" placeholder="ì´ëª¨í‹°ì½˜ì„ í™œìš©í•œ ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸°ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”..."></textarea>
      
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
      
      <div class="result-box" id="resultDisplay"></div>
      
      <div class="button-group">
        <button class="start-btn" id="startBtn">ğŸ² ì´ëª¨í‹°ì½˜ ë°›ê¸°</button>
        <button class="submit-btn" id="submitBtn" disabled>ğŸ“¨ ì´ì•¼ê¸° ì œì¶œ</button>
        <button class="save-btn" id="saveBtn" disabled>ğŸ’¾ ê²°ê³¼ ì €ì¥</button>
      </div>
    </div>
    
    <div id="leaderboard" class="tab-content">
      <div class="leaderboard">
        <h2>ğŸ† ìˆœìœ„í‘œ ğŸ†</h2>
        <table id="leaderboardTable">
          <thead>
            <tr>
              <th>ìˆœìœ„</th>
              <th>ë‹‰ë„¤ì„</th>
              <th>ì´ì </th>
              <th>ê²Œì„ìˆ˜</th>
              <th>í‰ê· </th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <!-- ìˆœìœ„ ë°ì´í„°ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div id="history" class="tab-content">
      <div class="recent-games">
        <h3>ë‚˜ì˜ ê²Œì„ ê¸°ë¡</h3>
        <div class="game-history" id="gameHistoryList">
          <!-- ê²Œì„ ê¸°ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- ë‹‰ë„¤ì„ ì„¤ì • ëª¨ë‹¬ -->
  <div class="nickname-modal" id="nicknameModal">
    <div class="modal-content">
      <h2>ë‹‰ë„¤ì„ ì„¤ì •</h2>
      <p>ê²Œì„ì„ ì‹œì‘í•˜ê¸° ì „ì— ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</p>
      <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ ì…ë ¥ (2-10ì)" maxlength="10">
      <button class="start-btn" id="saveNicknameBtn">ì‹œì‘í•˜ê¸°</button>
    </div>
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let currentEmojis = "";
    let currentScore = 0;
    let userNickname = "";
    let userTotalScore = 0;
    let userGamesCount = 0;
    let leaderboardData = JSON.parse(localStorage.getItem('emojiGameLeaderboard')) || [];
    let userGamesHistory = [];
    
    // DOM ìš”ì†Œ
    const apiKeyInput = document.getElementById('apiKeyInput');
    const emojiDisplay = document.getElementById('emojiDisplay');
    const storyInput = document.getElementById('storyInput');
    const resultDisplay = document.getElementById('resultDisplay');
    const startBtn = document.getElementById('startBtn');
    const submitBtn = document.getElementById('submitBtn');
    const saveBtn = document.getElementById('saveBtn');
    const loadingIndicator = document.getElementById('loading');
    const nicknameModal = document.getElementById('nicknameModal');
    const nicknameInput = document.getElementById('nicknameInput');
    const saveNicknameBtn = document.getElementById('saveNicknameBtn');
    const nicknameDisplay = document.getElementById('nicknameDisplay');
    const avatarDisplay = document.getElementById('avatarDisplay');
    const totalScoreDisplay = document.getElementById('totalScoreDisplay');
    const gamesCountDisplay = document.getElementById('gamesCountDisplay');
    const gameHistoryList = document.getElementById('gameHistoryList');
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹‰ë„¤ì„ í™•ì¸
    window.addEventListener('DOMContentLoaded', () => {
      checkNickname();
      updateLeaderboardDisplay();
      updateGameHistory();
    });
    
    // ë‹‰ë„¤ì„ í™•ì¸ í•¨ìˆ˜
    function checkNickname() {
      const savedNickname = localStorage.getItem('emojiGameNickname');
      if (savedNickname) {
        userNickname = savedNickname;
        nicknameDisplay.textContent = userNickname;
        avatarDisplay.textContent = userNickname.charAt(0).toUpperCase();
        
        // ìœ ì € ì ìˆ˜ ì •ë³´ ë¡œë“œ
        const userScoreData = getUserScoreData(userNickname);
        userTotalScore = userScoreData.totalScore;
        userGamesCount = userScoreData.gamesCount;
        userGamesHistory = userScoreData.history || [];
        
        totalScoreDisplay.textContent = userTotalScore;
        gamesCountDisplay.textContent = userGamesCount;
      } else {
        showNicknameModal();
      }
    }
    
    // ë‹‰ë„¤ì„ ëª¨ë‹¬ í‘œì‹œ
    function showNicknameModal() {
      nicknameModal.style.display = 'flex';
    }
    
    // ë‹‰ë„¤ì„ ì €ì¥
    saveNicknameBtn.addEventListener('click', () => {
      const nickname = nicknameInput.value.trim();
      if (nickname.length < 2) {
        alert('ë‹‰ë„¤ì„ì€ ìµœì†Œ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      userNickname = nickname;
      localStorage.setItem('emojiGameNickname', userNickname);
      nicknameDisplay.textContent = userNickname;
      avatarDisplay.textContent = userNickname.charAt(0).toUpperCase();
      nicknameModal.style.display = 'none';
      
      // ìƒˆ ì‚¬ìš©ìì˜ ê²½ìš° ì´ˆê¸°í™”
      userTotalScore = 0;
      userGamesCount = 0;
      userGamesHistory = [];
      totalScoreDisplay.textContent = userTotalScore;
      gamesCountDisplay.textContent = userGamesCount;
    });
    
    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    function openTab(tabName) {
      const tabs = document.getElementsByClassName('tab');
      const tabContents = document.getElementsByClassName('tab-content');
      
      for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
        tabContents[i].classList.remove('active');
      }
      
      document.getElementById(tabName).classList.add('active');
      event.currentTarget.classList.add('active');
      
      if (tabName === 'leaderboard') {
        updateLeaderboardDisplay();
      } else if (tabName === 'history') {
        updateGameHistory();
      }
    }
    
    // Groq API í˜¸ì¶œ í•¨ìˆ˜
    async function callGroqAPI(prompt) {
      const apiKey = apiKeyInput.value; // ì½”ë“œì— í¬í•¨ëœ API í‚¤ ì‚¬ìš©
      
      try {
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: "meta-llama/llama-4-scout-17b-16e-instruct",
            messages: [{ role: "user", content: prompt }]
          })
        });
        
        if (!response.ok) {
          throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content.trim();
      } catch (error) {
        console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
        alert(`API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        return null;
      }
    }
    
    // ì´ëª¨í‹°ì½˜ ìƒì„±
    async function getEmojisFromAI() {
      loadingIndicator.style.display = 'block';
      const prompt = "ì¬ë¯¸ìˆëŠ” ì´ì•¼ê¸° ì£¼ì œë¡œ ì“¸ ìˆ˜ ìˆëŠ” ì´ëª¨í‹°ì½˜ì„ 3~5ê°œ ì œì‹œí•´ì¤˜. ë‹¤ë¥¸ ì„¤ëª…ì€ í•˜ì§€ ë§ê³  ì´ëª¨í‹°ì½˜ë§Œ ë³´ì—¬ì¤˜.";
      
      const emojis = await callGroqAPI(prompt);
      loadingIndicator.style.display = 'none';
      
      if (emojis) {
        return emojis;
      }
      return null;
    }
    
    // ì´ì•¼ê¸° í‰ê°€
    async function evaluateStory(emojis, story) {
      loadingIndicator.style.display = 'block';
      const prompt = `
        ë‹¤ìŒ ì´ëª¨í‹°ì½˜ë“¤ì„ í™œìš©í•˜ì—¬ ì‚¬ìš©ìê°€ ì“´ ì´ì•¼ê¸°ë¥¼ í‰ê°€í•´ì¤˜.

        ì´ëª¨í‹°ì½˜: ${emojis}
        ì´ì•¼ê¸°: ${story}

        0ì ì—ì„œ 100ì  ì‚¬ì´ ì ìˆ˜ì™€ ê°„ë‹¨í•œ í‰ê°€ë¥¼ í•´ì¤˜. í˜•ì‹ì€ ì•„ë˜ì²˜ëŸ¼ í•´ì¤˜:

        ì ìˆ˜: [ìˆ«ì]
        í‰ê°€: [ê°„ë‹¨í•œ í”¼ë“œë°±]
      `;
      
      const evaluation = await callGroqAPI(prompt);
      loadingIndicator.style.display = 'none';
      
      if (evaluation) {
        // ì ìˆ˜ ì¶”ì¶œ
        const scoreMatch = evaluation.match(/ì ìˆ˜:\s*(\d+)/);
        if (scoreMatch && scoreMatch[1]) {
          currentScore = parseInt(scoreMatch[1]);
        }
        return evaluation;
      }
      return null;
    }
    
    // ìœ ì € ì ìˆ˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function getUserScoreData(nickname) {
      // ë¨¼ì € ìˆœìœ„í‘œì—ì„œ í•´ë‹¹ ì‚¬ìš©ì ì°¾ê¸°
      let userData = null;
      for (const entry of leaderboardData) {
        if (entry.nickname === nickname) {
          userData = entry;
          break;
        }
      }
      
      // ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
      if (!userData) {
        return {
          nickname: nickname,
          totalScore: 0,
          gamesCount: 0,
          history: []
        };
      }
      
      return userData;
    }
    
    // ê²°ê³¼ ì €ì¥ í•¨ìˆ˜
    function saveResult() {
      const story = storyInput.value.trim();
      const result = resultDisplay.innerHTML;
      
      if (!story || !result || !currentScore) {
        alert('ì´ì•¼ê¸°ë‚˜ í‰ê°€ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      if (!userNickname) {
        alert('ë‹‰ë„¤ì„ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        showNicknameModal();
        return;
      }
      
      // í˜„ì¬ ë‚ ì§œ
      const now = new Date();
      const dateStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
      const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      
      // ê²Œì„ ê²°ê³¼
      const gameResult = {
        emojis: currentEmojis,
        score: currentScore,
        date: dateStr,
        time: timeStr,
        story: story,
        evaluation: result
      };
      
      // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
      let userData = null;
      let userIndex = -1;
      
      // ê¸°ì¡´ ì‚¬ìš©ì ì°¾ê¸°
      for (let i = 0; i < leaderboardData.length; i++) {
        if (leaderboardData[i].nickname === userNickname) {
          userData = leaderboardData[i];
          userIndex = i;
          break;
        }
      }
      
      // ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
      if (!userData) {
        userData = {
          nickname: userNickname,
          totalScore: currentScore,
          gamesCount: 1,
          history: [gameResult]
        };
        leaderboardData.push(userData);
      } else {
        // ê¸°ì¡´ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
        userData.totalScore += currentScore;
        userData.gamesCount += 1;
        
        // íˆìŠ¤í† ë¦¬ ë°°ì—´ì´ ì—†ìœ¼ë©´ ìƒì„±
        if (!userData.history) {
          userData.history = [];
        }
        
        // íˆìŠ¤í† ë¦¬ì— ê²Œì„ ê²°ê³¼ ì¶”ê°€
        userData.history.push(gameResult);
        
        // ìµœëŒ€ 20ê°œê¹Œì§€ë§Œ ìœ ì§€
        if (userData.history.length > 20) {
          userData.history = userData.history.slice(-20);
        }
        
        // ë¦¬ë”ë³´ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
        leaderboardData[userIndex] = userData;
      }
      
      // ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
      leaderboardData.sort((a, b) => b.totalScore - a.totalScore);
      
      // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
      localStorage.setItem('emojiGameLeaderboard', JSON.stringify(leaderboardData));
      
      // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
      userTotalScore = userData.totalScore;
      userGamesCount = userData.gamesCount;
      userGamesHistory = userData.history;
      
      // UI ì—…ë°ì´íŠ¸
      totalScoreDisplay.textContent = userTotalScore;
      gamesCountDisplay.textContent = userGamesCount;
      
      alert('ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
      
      // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
      saveBtn.disabled = true;
      submitBtn.disabled = true;
      
      // íˆìŠ¤í† ë¦¬ íƒ­ ì—…ë°ì´íŠ¸
      updateGameHistory();
    }
    
    // ìˆœìœ„í‘œ ì—…ë°ì´íŠ¸
    function updateLeaderboardDisplay() {
      const leaderboardBody = document.getElementById('leaderboardBody');
      leaderboardBody.innerHTML = '';
      
      if (leaderboardData.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="5" style="text-align:center;">ì•„ì§ ì €ì¥ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
        leaderboardBody.appendChild(row);
        return;
      }
      
      leaderboardData.forEach((entry, index) => {
        const row = document.createElement('tr');
        
        // ë©”ë‹¬ í‘œì‹œ
        let rankDisplay = `${index + 1}`;
        if (index === 0) rankDisplay = `<span class="medal">ğŸ¥‡</span>`;
        else if (index === 1) rankDisplay = `<span class="medal">ğŸ¥ˆ</span>`;
        else if (index === 2) rankDisplay = `<span class="medal">ğŸ¥‰</span>`;
        
        // í‰ê·  ì ìˆ˜ ê³„ì‚°
        const avgScore = entry.gamesCount > 0 ? 
          Math.round(entry.totalScore / entry.gamesCount) : 0;
        
        row.innerHTML = `
          <td>${rankDisplay}</td>
          <td>${entry.nickname}</td>
          <td class="score">${entry.totalScore}</td>
          <td>${entry.gamesCount}</td>
          <td>${avgScore}</td>
        `;
        
        // í˜„ì¬ ì‚¬ìš©ì í•˜ì´ë¼ì´íŠ¸
        if (entry.nickname === userNickname) {
          row.style.backgroundColor = "#fff8e1";
          row.style.fontWeight = "bold";
        }
        
        leaderboardBody.appendChild(row);
      });
    }
    
    // ê²Œì„ íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
    function updateGameHistory() {
      gameHistoryList.innerHTML = '';
      
      if (!userNickname) {
        gameHistoryList.innerHTML = '<div style="text-align:center;padding:20px;">ë‹‰ë„¤ì„ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
        return;
      }
      
      if (!userGamesHistory || userGamesHistory.length === 0) {
        gameHistoryList.innerHTML = '<div style="text-align:center;padding:20px;">ì•„ì§ ì €ì¥ëœ ê²Œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
      const sortedHistory = [...userGamesHistory].reverse();
      
      sortedHistory.forEach(game => {
        const gameItem = document.createElement('div');
        gameItem.className = 'game-item';
        
        gameItem.innerHTML = `
          <div>
            <strong>${game.date} ${game.time}</strong>
            <div>${game.emojis}</div>
          </div>
          <div class="score">${game.score}ì </div>
        `;
        
        // ê²Œì„ ìƒì„¸ ì •ë³´ í‘œì‹œ
        gameItem.addEventListener('click', () => {
          alert(`[${game.date} ${game.time} ê²Œì„]\n\nì´ëª¨í‹°ì½˜: ${game.emojis}\n\n${game.story}\n\ní‰ê°€:\n${game.evaluation.replace(/<br>/g, '\n')}`);
        });
        
        gameHistoryList.appendChild(gameItem);
      });
    }
    
    // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    startBtn.addEventListener('click', async () => {
      if (!userNickname) {
        alert('ë‹‰ë„¤ì„ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        showNicknameModal();
        return;
      }
      
      const emojis = await getEmojisFromAI();
      if (emojis) {
        currentEmojis = emojis;
        emojiDisplay.textContent = emojis;
        storyInput.value = '';
        resultDisplay.innerHTML = '';
        submitBtn.disabled = false;
        saveBtn.disabled = true;
      }
    });
    
    submitBtn.addEventListener('click', async () => {
      const story = storyInput.value.trim();
      if (!story) {
        alert('ì´ì•¼ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      const result = await evaluateStory(currentEmojis, story);
      if (result) {
        resultDisplay.innerHTML = result.replace(/\n/g, '<br>');
        saveBtn.disabled = false;
      }
    });
    
    saveBtn.addEventListener('click', saveResult);
    
    // ë‹‰ë„¤ì„ ì…ë ¥ ì—”í„°í‚¤ ì²˜ë¦¬
    nicknameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        saveNicknameBtn.click();
      }
    });
  </script>
</body>
</html>
