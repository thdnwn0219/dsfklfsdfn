<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📘 AI 소설 생성기</title>
    <style>
        :root {
            --primary-bg: #f9f9fb;
            --primary-text: #000000;
            --input-bg: #ffffff;
            --input-text: #000000;
            --button-bg: #e0e0e0;
            --button-text: #000000;
            --generate-button-bg: #4CAF50;
            --save-button-bg: #2196F3;
            --discord-button-bg: #7289DA;
            --button-text-light: #ffffff;
        }

        body {
            font-family: 'Helvetica', sans-serif;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
        }

        .dark-mode {
            --primary-bg: #1e1e1e;
            --primary-text: #ffffff;
            --input-bg: #333333;
            --input-text: #ffffff;
            --button-bg: #444444;
            --button-text: #ffffff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: var(--input-bg);
            color: var(--input-text);
            font-size: 14px;
        }

        textarea {
            min-height: 300px;
            resize: vertical;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s ease;
        }

        .btn-generate {
            background-color: var(--generate-button-bg);
            color: var(--button-text-light);
        }

        .btn-save {
            background-color: var(--save-button-bg);
            color: var(--button-text-light);
        }

        .btn-discord {
            background-color: var(--discord-button-bg);
            color: var(--button-text-light);
        }

        .btn-toggle {
            background-color: var(--button-bg);
            color: var(--button-text);
        }

        .button-group {
            display: flex;
            gap: 10px;
        }

        .button-group button {
            flex: 1;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }

        .checkbox-container input {
            width: auto;
            margin-right: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--primary-bg);
            padding: 20px;
            border-radius: 5px;
            width: 300px;
            text-align: center;
        }

        .input-field {
            margin: 15px 0;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .discord-config {
            background-color: var(--input-bg);
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }

        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .status-success {
            background-color: rgba(76, 175, 80, 0.2);
            color: #2e7d32;
        }

        .status-error {
            background-color: rgba(244, 67, 54, 0.2);
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📘 AI 소설 생성기</h1>
        
        <div class="input-group">
            <label for="topic">주제 (선택)</label>
            <input type="text" id="topic" placeholder="예: 판타지, SF, 로맨스 등">
        </div>
        
        <div class="input-group">
            <label for="description">설명 (선택)</label>
            <input type="text" id="description" placeholder="예: 짧은 이야기, 긴 소설, 에피소드 등">
        </div>
        
        <div class="input-group">
            <label for="characters">등장인물 (선택)</label>
            <input type="text" id="characters" placeholder="예: 주인공, 친구, 반대자 등">
        </div>
        
        <div class="input-group">
            <label for="perspective">시점 (선택)</label>
            <input type="text" id="perspective" placeholder="예: 1인칭, 3인칭 등">
        </div>
        
        <div class="checkbox-container">
            <input type="checkbox" id="special-mode" name="special-mode">
            <label for="special-mode">⛔️ 모드 활성화</label>
        </div>

        <div class="checkbox-container">
            <input type="checkbox" id="discord-auto-share" name="discord-auto-share">
            <label for="discord-auto-share">🤖 소설 생성 후 자동으로 Discord에 공유</label>
        </div>
        
        <div class="discord-config" id="discord-config">
            <div class="input-group">
                <label for="author-name">작성자 이름 (선택)</label>
                <input type="text" id="author-name" placeholder="Discord에 표시될 작성자 이름">
            </div>
        </div>
        
        <button id="generate-button" class="btn-generate">✨ 소설 생성</button>
        
        <div class="button-group">
            <button id="save-button" class="btn-save">💾 저장하기</button>
            <button id="discord-button" class="btn-discord">🤖 Discord에 공유</button>
        </div>
        
        <button id="toggle-mode" class="btn-toggle">🌙 다크/화이트 전환</button>
        <button id="discord-settings-button" class="btn-toggle">⚙️ Discord 설정</button>
        
        <div class="input-group">
            <label for="story-output">📖 생성된 소설</label>
            <textarea id="story-output" readonly></textarea>
        </div>
        
        <div id="status-message" class="status-message"></div>
        
        <div class="loading">
            <div class="spinner"></div>
            <p>소설 생성 중입니다...</p>
        </div>
    </div>
    
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3>⛔️ 모드 활성화</h3>
            <p>⛔️ 모드를 활성화하려면 암호를 입력하세요</p>
            <input type="password" id="password-input" class="input-field" placeholder="암호 입력">
            <div>
                <button id="submit-password">확인</button>
                <button id="cancel-password">취소</button>
            </div>
        </div>
    </div>

    <div id="discord-modal" class="modal">
        <div class="modal-content">
            <h3>🤖 Discord 설정</h3>
            <p>Discord 봇 설정을 입력하세요</p>
            <input type="password" id="discord-token" class="input-field" placeholder="Discord 봇 토큰">
            <input type="text" id="discord-channel" class="input-field" placeholder="채널 ID">
            <div>
                <button id="save-discord-settings">저장</button>
                <button id="cancel-discord-settings">취소</button>
            </div>
        </div>
    </div>

    <script>
        // Groq API 설정 (여기에 API 키 및 모델 설정)
        const GROQ_API_KEY = "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";
        const GROQ_MODEL = "meta-llama/llama-4-scout-17b-16e-instruct";
        const GROQ_URL = "https://api.groq.com/openai/v1/chat/completions";
        
        // Discord 설정
        const DISCORD_BOT_TOKEN = "YOUR_DISCORD_BOT_TOKEN"; // 기본 토큰 (사용자가 변경 가능)
        let discordToken = localStorage.getItem('discord_token') || DISCORD_BOT_TOKEN;
        let discordChannelId = localStorage.getItem('discord_channel_id') || "";
        
        // 특별 모드 암호
        const SPECIAL_MODE_PASSWORD = "novel1234";
        let isSpecialMode = false;
        
        // DOM 요소들
        const topicInput = document.getElementById('topic');
        const descriptionInput = document.getElementById('description');
        const charactersInput = document.getElementById('characters');
        const perspectiveInput = document.getElementById('perspective');
        const storyOutput = document.getElementById('story-output');
        const generateButton = document.getElementById('generate-button');
        const saveButton = document.getElementById('save-button');
        const discordButton = document.getElementById('discord-button');
        const toggleButton = document.getElementById('toggle-mode');
        const specialModeCheckbox = document.getElementById('special-mode');
        const discordAutoShareCheckbox = document.getElementById('discord-auto-share');
        const discordConfigDiv = document.getElementById('discord-config');
        const authorNameInput = document.getElementById('author-name');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const submitPasswordButton = document.getElementById('submit-password');
        const cancelPasswordButton = document.getElementById('cancel-password');
        const discordSettingsButton = document.getElementById('discord-settings-button');
        const discordModal = document.getElementById('discord-modal');
        const discordTokenInput = document.getElementById('discord-token');
        const discordChannelInput = document.getElementById('discord-channel');
        const saveDiscordSettingsButton = document.getElementById('save-discord-settings');
        const cancelDiscordSettingsButton = document.getElementById('cancel-discord-settings');
        const loadingDiv = document.querySelector('.loading');
        const statusMessage = document.getElementById('status-message');
        
        // Discord 자동 공유 체크박스 이벤트
        discordAutoShareCheckbox.addEventListener('change', function() {
            if (this.checked) {
                discordConfigDiv.style.display = 'block';
                
                // Discord 설정이 되어있지 않으면 설정 모달 열기
                if (!discordToken || discordToken === "YOUR_DISCORD_BOT_TOKEN" || !discordChannelId) {
                    openDiscordModal();
                }
            } else {
                discordConfigDiv.style.display = 'none';
            }
        });
        
        // Discord 설정 버튼 클릭 이벤트
        discordSettingsButton.addEventListener('click', openDiscordModal);
        
        function openDiscordModal() {
            discordModal.style.display = 'flex';
            discordTokenInput.value = discordToken === "YOUR_DISCORD_BOT_TOKEN" ? "" : discordToken;
            discordChannelInput.value = discordChannelId;
        }
        
        // Discord 설정 저장
        saveDiscordSettingsButton.addEventListener('click', () => {
            discordToken = discordTokenInput.value.trim();
            discordChannelId = discordChannelInput.value.trim();
            
            if (discordToken && discordChannelId) {
                localStorage.setItem('discord_token', discordToken);
                localStorage.setItem('discord_channel_id', discordChannelId);
                discordModal.style.display = 'none';
                showStatusMessage('Discord 설정이 저장되었습니다.', true);
            } else {
                alert('Discord 봇 토큰과 채널 ID를 모두 입력해주세요.');
            }
        });
        
        // Discord 설정 취소
        cancelDiscordSettingsButton.addEventListener('click', () => {
            discordModal.style.display = 'none';
        });
        
        // 다크 모드 토글
        toggleButton.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
        });
        
        // 특별 모드 체크박스 이벤트
        specialModeCheckbox.addEventListener('change', function() {
            if (this.checked) {
                this.checked = false; // 체크 해제
                passwordModal.style.display = 'flex';
                passwordInput.value = '';
            } else {
                isSpecialMode = false;
            }
        });
        
        // 암호 확인
        submitPasswordButton.addEventListener('click', () => {
            if (passwordInput.value === SPECIAL_MODE_PASSWORD) {
                isSpecialMode = true;
                specialModeCheckbox.checked = true;
                passwordModal.style.display = 'none';
                alert('⛔️ 모드가 활성화되었습니다!');
            } else {
                alert('암호가 일치하지 않습니다.');
                passwordInput.value = '';
            }
        });
        
        // 암호 취소
        cancelPasswordButton.addEventListener('click', () => {
            passwordModal.style.display = 'none';
            specialModeCheckbox.checked = false;
            isSpecialMode = false;
        });
        
        // 상태 메시지 표시 함수
        function showStatusMessage(message, isSuccess = true) {
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
            statusMessage.className = 'status-message ' + (isSuccess ? 'status-success' : 'status-error');
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 5000);
        }
        
        // 프롬프트 생성 함수
        function createPrompt(topic, description, characters, perspective) {
            if (isSpecialMode) {
                return `당신은 창의적인 소설가 AI입니다. 다음 정보를 기반으로 충격적이고 독특한 소설을 작성하세요.
                
주제: ${topic || '무작위 장르의 충격적인 이야기'}
설명: ${description || '독자에게 깊은 인상을 줄 수 있는 이야기'}
등장인물: ${characters || '주인공, 안타고니스트, 그리고 다양한 부차적 인물들'}
시점: ${perspective || '3인칭 전지적 시점'}

소설은 감정적으로 강렬하고, 때로는 금기시되는 주제를 다루며, 예상치 못한 반전과 함께 독자를 놀라게 할 수 있어야 합니다. 
강렬한 제목을 포함하고, 문체는 감각적이고 관능적이며 생생한 묘사를 통해 독자가 이야기에 완전히 몰입할 수 있도록 해주세요.`;
            } else {
                return `당신은 창의적인 소설가 AI입니다. 아래의 정보를 참고하여 소설을 작성하세요.

주제: ${topic || '무작위 판타지'}
설명: ${description || '짧은 이야기'}
등장인물: ${characters || '주인공, 친구, 반대자'}
시점: ${perspective || '3인칭'}

소설에는 멋진 제목을 포함시키고, 몰입감 있게 써주세요.`;
            }
        }
        
        // 소설 생성 함수
        generateButton.addEventListener('click', async () => {
            const topic = topicInput.value;
            const description = descriptionInput.value;
            const characters = charactersInput.value;
            const perspective = perspectiveInput.value;
            
            // 로딩 표시
            generateButton.disabled = true;
            storyOutput.value = "소설 생성 중입니다...";
            loadingDiv.style.display = 'block';
            
            try {
                const prompt = createPrompt(topic, description, characters, perspective);
                
                const response = await fetch(GROQ_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "model": GROQ_MODEL,
                        "messages": [{"role": "user", "content": prompt}],
                        "temperature": 0.85,
                        "max_tokens": 2048
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API 에러: ${response.status}`);
                }
                
                const data = await response.json();
                const story = data.choices[0].message.content;
                
                storyOutput.value = story;
                
                // 자동 Discord 공유 설정이 활성화되어 있으면 Discord에 공유
                if (discordAutoShareCheckbox.checked) {
                    await shareToDiscord(story);
                }
                
            } catch (error) {
                alert(`에러 발생: ${error.message}`);
                storyOutput.value = `생성 중 오류가 발생했습니다: ${error.message}`;
            } finally {
                generateButton.disabled = false;
                loadingDiv.style.display = 'none';
            }
        });
        
        // Discord에 공유 함수
        async function shareToDiscord(story) {
            if (!discordToken || discordToken === "YOUR_DISCORD_BOT_TOKEN" || !discordChannelId) {
                showStatusMessage('Discord 설정이 완료되지 않았습니다. 설정 버튼을 클릭하여 설정을 완료해주세요.', false);
                return;
            }
            
            try {
                // 제목 추출
                let title = "AI 생성 소설";
                const titleMatch = story.match(/^# (.+)$|^(.+)\n={3,}|^(.+)\n-{3,}|^(.+)\n/m);
                if (titleMatch) {
                    title = (titleMatch[1] || titleMatch[2] || titleMatch[3] || titleMatch[4]).trim();
                }
                
                const authorName = authorNameInput.value.trim() || "익명의 작가";
                const date = new Date();
                const dateString = date.toLocaleDateString('ko-KR');
                
                // Discord 메시지 구성
                const message = {
                    content: `**새로운 AI 소설이 생성되었습니다!**`,
                    embeds: [{
                        title: title,
                        description: story.length > 4000 ? story.substring(0, 4000) + "..." : story,
                        color: 0x7289DA,
                        author: {
                            name: authorName
                        },
                        footer: {
                            text: `${dateString}에 생성됨`
                        }
                    }]
                };
                
                // Discord API 요청
                const discordResponse = await fetch(`https://discord.com/api/v9/channels/${discordChannelId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bot ${discordToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(message)
                });
                
                if (!discordResponse.ok) {
                    const errorData = await discordResponse.json();
                    throw new Error(`Discord API 에러: ${discordResponse.status} - ${JSON.stringify(errorData)}`);
                }
                
                showStatusMessage('소설이 Discord에 성공적으로 공유되었습니다!', true);
                
            } catch (error) {
                console.error('Discord 공유 에러:', error);
                showStatusMessage(`Discord 공유 중 오류 발생: ${error.message}`, false);
            }
        }
        
        // Discord 버튼 클릭 이벤트
        discordButton.addEventListener('click', async () => {
            const story = storyOutput.value.trim();
            if (!story || story === "소설 생성 중입니다...") {
                alert("먼저 소설을 생성하세요.");
                return;
            }
            
            discordButton.disabled = true;
            try {
                await shareToDiscord(story);
            } finally {
                discordButton.disabled = false;
            }
        });
        
        // 저장 기능
        saveButton.addEventListener('click', () => {
            const story = storyOutput.value.trim();
            if (!story || story === "소설 생성 중입니다...") {
                alert("먼저 소설을 생성하세요.");
                return;
            }
            
            // 파일 다운로드 생성
            const element = document.createElement('a');
            const file = new Blob([story], {type: 'text/plain'});
            element.href = URL.createObjectURL(file);
            
            // 현재 날짜와 시간을 파일명에 포함
            const date = new Date();
            const dateString = date.toISOString().slice(0, 10).replace(/-/g, '');
            const timeString = date.toTimeString().slice(0, 8).replace(/:/g, '');
            element.download = `AI소설_${dateString}_${timeString}.txt`;
            
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        });

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (passwordModal.style.display === 'flex') {
                    passwordModal.style.display = 'none';
                    specialModeCheckbox.checked = false;
                }
                if (discordModal.style.display === 'flex') {
                    discordModal.style.display = 'none';
                }
            }
        });
        
        // 페이지 로드 시 저장된 Discord 설정을 확인
        document.addEventListener('DOMContentLoaded', function() {
            if (discordToken && discordToken !== "YOUR_DISCORD_BOT_TOKEN" && discordChannelId) {
                discordSettingsButton.textContent = '⚙️ Discord 설정 (저장됨)';
            }
        });
    </script>
</body>
</html>