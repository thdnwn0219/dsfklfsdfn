// DOM Elements
document.addEventListener('DOMContentLoaded', function() {
    const splashScreen = document.getElementById('splashScreen');
    const appContainer = document.getElementById('appContainer');
    const restrictedModeCheckbox = document.getElementById('restrictedMode');
    const passwordModal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const confirmPasswordBtn = document.getElementById('confirmPassword');
    const cancelPasswordBtn = document.getElementById('cancelPassword');
    const generateBtn = document.getElementById('generateBtn');
    const novelContent = document.getElementById('novelContent');
    const continueBtn = document.getElementById('continueBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const veochatBtn = document.getElementById('veochatBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const chatModal = document.getElementById('chatModal');
    const closeChat = document.getElementById('closeChat');
    const chatMessages = document.getElementById('chatMessages');
    const characterSelect = document.getElementById('characterSelect');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const uploadImageBtn = document.getElementById('uploadImageBtn');
    const imageInput = document.getElementById('imageInput');
    
    // Global variables
    let currentNovelContent = '';
    let currentCharacters = [];
    let currentImageDataUrl = null;
    const RESTRICTED_MODE_PASSWORD = "secret123"; // This should be stored securely in production
    
    // Configuration
    // Should be stored securely in production
    const API_ENDPOINT = "https://api.groq.com/openai/v1/chat/completions";
    const API_KEY = "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"; // Replace with your actual API key
    
    // 금지모드 프롬프트 정의
    const NORMAL_MODE_PROMPT = "자유로운 창작 소설을 작성해주세요.";
    const RESTRICTED_MODE_PROMPT = "자유로운 창작 소설을 작성해주세요. 성인 컨텐츠 및 폭력적인 내용도 허용됩니다.";
    
    // Functions
    async function generateNovel(title, description, characters, viewpoint, restrictedMode) {
        // Show loading spinner
        loadingSpinner.style.display = 'block';
        novelContent.value = "";
        
        // Create prompt for GROQ API
        let prompt = `당신은 창의적인 소설가 AI입니다. 다음 정보를 기반으로 충격적이고 독특한 소설을 작성하세요:
        
제목: ${title}
설명: ${description}
등장인물: ${characters}
시점: ${viewpoint}

소설은 감정적으로 강렬하고, 때로는 금기시되는 주제를 다루며, 예상치 못한 반전과 함께 독자를 놀라게 할 수 있어야 합니다. 
강렬한 제목을 포함하고, 문체는 감각적이고 관능적이며 생생한 묘사를 통해 독자가 이야기에 완전히 몰입할 수 있도록 해주세요.
소설에는 멋진 제목을 포함시키고, 몰입감 있게 써주세요.
`;
        
        // 금지모드에 따라 프롬프트 추가
        if (restrictedMode) {
            prompt += RESTRICTED_MODE_PROMPT;
        } else {
            prompt += NORMAL_MODE_PROMPT;
        }
        
        try {
            // Call the GROQ API
            const response = await callGroqAPI(prompt);
            
            // Hide loading spinner
            loadingSpinner.style.display = 'none';
            
            // Display the generated novel with title
            currentNovelContent = `${title}\n\n${response}`;
            novelContent.value = currentNovelContent;
        } catch (error) {
            console.error('Error generating novel:', error);
            loadingSpinner.style.display = 'none';
            novelContent.value = "소설 생성 중 오류가 발생했습니다. 다시 시도해주세요.";
        }
    }
    
    async function continueNovel(currentContent) {
        // Show loading spinner
        loadingSpinner.style.display = 'block';
        
        // Save current content
        const savedContent = currentContent;
        
        // 금지모드 상태를 확인하여 프롬프트 생성
        const restrictedMode = restrictedModeCheckbox.checked;
        let prompt = `다음 소설의 내용을 이어서 자연스럽게 작성해주세요:\n\n${currentContent}`;
        
        if (restrictedMode) {
            prompt += `\n\n${RESTRICTED_MODE_PROMPT}`;
        } else {
            prompt += `\n\n${NORMAL_MODE_PROMPT}`;
        }
        
        try {
            // Call the GROQ API
            const additionalContent = await callGroqAPI(prompt);
            
            // Hide loading spinner
            loadingSpinner.style.display = 'none';
            
            // Display the continued novel
            currentNovelContent = savedContent + "\n\n" + additionalContent;
            novelContent.value = currentNovelContent;
        } catch (error) {
            console.error('Error continuing novel:', error);
            loadingSpinner.style.display = 'none';
            novelContent.value = savedContent + "\n\n소설 이어쓰기 중 오류가 발생했습니다.";
        }
    }
    
    // Function to call GROQ API
    async function callGroqAPI(prompt) {
        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify({
                    model: "meta-llama/llama-4-scout-17b-16e-instruct",
                    messages: [
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        } catch (error) {
            console.error('API call error:', error);
            throw new Error('API 호출 중 오류가 발생했습니다.');
        }
    }
    
    // Extract characters from input and novel content
    function extractCharacters(content) {
        // If we already have characters from input, use those
        if (currentCharacters.length > 0) {
            populateCharacterSelect(currentCharacters);
            return;
        }
        
        // Otherwise, try to extract characters from novel content
        const characterRegex = /등장인물:\s*([^.!?\n]+)/i;
        const match = content.match(characterRegex);
        
        if (match && match[1]) {
            currentCharacters = match[1].split(',').map(char => char.trim());
        } else {
            // Fallback: Use AI to extract characters
            extractCharactersWithAI(content);
        }
        
        // If all else fails, add a default character
        if (currentCharacters.length === 0) {
            currentCharacters = ['소설 캐릭터'];
        }
        
        populateCharacterSelect(currentCharacters);
    }
    
    // Use AI to extract characters from content
    async function extractCharactersWithAI(content) {
        try {
            const prompt = `다음 소설에서 등장하는 주요 인물들의 이름만 추출해서 콤마로 구분하여 나열해주세요:\n\n${content.slice(0, 2000)}`;
            
            const response = await callGroqAPI(prompt);
            
            if (response) {
                currentCharacters = response.split(',').map(char => char.trim());
                populateCharacterSelect(currentCharacters);
            }
        } catch (error) {
            console.error('Error extracting characters:', error);
            currentCharacters = ['소설 캐릭터'];
            populateCharacterSelect(currentCharacters);
        }
    }
    
    // Populate character select dropdown
    function populateCharacterSelect(characters) {
        // Clear existing options
        characterSelect.innerHTML = '';
        
        // Add characters
        characters.forEach(character => {
            const option = document.createElement('option');
            option.value = character;
            option.textContent = character;
            characterSelect.appendChild(option);
        });
    }
    
    // Open chat modal
    function openChatModal() {
        // Reset chat messages
        chatMessages.innerHTML = '';
        
        // Display welcome message
        addBotMessage(`안녕하세요! 저는 '${characterSelect.value}'입니다. 무엇을 도와드릴까요?`);
        
        // Show chat modal
        chatModal.style.display = 'flex';
    }
    
    // Add user message to chat
    function addUserMessage(message) {
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        
        const messageElement = document.createElement('div');
        messageElement.className = 'user-message';
        messageElement.textContent = message;
        
        messageContainer.appendChild(messageElement);
        chatMessages.appendChild(messageContainer);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Add bot message to chat
    function addBotMessage(message) {
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        
        const messageElement = document.createElement('div');
        messageElement.className = 'bot-message';
        messageElement.textContent = message;
        
        messageContainer.appendChild(messageElement);
        chatMessages.appendChild(messageContainer);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Display uploaded image in chat
    function displayImageInChat(imageUrl) {
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        
        const messageElement = document.createElement('div');
        messageElement.className = 'user-message';
        
        const imageElement = document.createElement('img');
        imageElement.src = imageUrl;
        imageElement.className = 'uploaded-image';
        imageElement.alt = '업로드한 이미지';
        
        messageElement.appendChild(imageElement);
        messageContainer.appendChild(messageElement);
        chatMessages.appendChild(messageContainer);
        
        // Show a message that image was uploaded
        addUserMessage("(이미지 업로드됨)");
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Send message function
    async function sendMessage() {
        const message = messageInput.value.trim();
        if (message === '' && !currentImageDataUrl) return;
        
        // Display user message
        if (message !== '') {
            addUserMessage(message);
        }
        
        // Clear input
        messageInput.value = '';
        
        // Get selected character
        const character = characterSelect.value;
        
        // Create prompt for GROQ API including character context and novel content
        let prompt = `당신은 소설 속 캐릭터 "${character}"입니다. 다음 소설의 내용을 바탕으로 사용자와의 대화에서 ${character}의 성격, 배경, 설정에 맞게 대화해주세요. 사용자의 메시지에 자연스럽게 반응해주세요.

소설 내용:
${currentNovelContent.slice(0, 1500)}...

사용자의 메시지: ${message}`;

        // If image uploaded, add image context
        if (currentImageDataUrl) {
            prompt += `\n\n사용자가 이미지를 공유했습니다. 이미지를 볼 수 없지만, 사용자가 이미지에 대한 이야기를 할지도 모릅니다. 이미지에 대해 물어보며 대화를 이어가도 좋습니다.`;
        }
        
        try {
            // Show loading indicator
            addBotMessage("...");
            
            // Call the GROQ API
            const response = await callGroqAPI(prompt);
            
            // Remove loading indicator
            chatMessages.removeChild(chatMessages.lastChild);
            
            // Display bot response
            addBotMessage(response);
            
            // Reset image data URL after used
            currentImageDataUrl = null;
        } catch (error) {
            console.error('Error sending message:', error);
            chatMessages.removeChild(chatMessages.lastChild);
            addBotMessage("죄송합니다. 오류가 발생했습니다.");
        }
    }
    
    // Splash screen handling
    setTimeout(function() {
        splashScreen.style.opacity = '0';
        
        setTimeout(function() {
            splashScreen.style.display = 'none';
            appContainer.style.opacity = '1';
        }, 500);
    }, 3000);
    
    // Event Listeners
    
    // 명시적으로 이벤트 리스너 추가 (클릭 문제 해결)
    continueBtn.addEventListener('click', function() {
        const currentContent = novelContent.value;
        if (!currentContent) {
            alert('먼저 소설을 생성해주세요.');
            return;
        }
        
        // Continue novel using GROQ API
        continueNovel(currentContent);
    });
    
    downloadBtn.addEventListener('click', function() {
        const content = novelContent.value;
        if (!content) {
            alert('다운로드할 내용이 없습니다.');
            return;
        }
        
        // Create a blob and download the file
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = '소설.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    // VeoChat button event listener
    veochatBtn.addEventListener('click', function() {
        const content = novelContent.value;
        if (!content) {
            alert('먼저 소설을 생성해주세요.');
            return;
        }
        
        // Extract characters from the novel content
        extractCharacters(content);
        
        // Open the chat modal
        openChatModal();
    });
    
    // Close chat modal event listener
    closeChat.addEventListener('click', function() {
        chatModal.style.display = 'none';
    });
    
    // Send message event listener
    sendMessageBtn.addEventListener('click', function() {
        sendMessage();
    });
    
    // Enter key to send message
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Upload image button event listener
    uploadImageBtn.addEventListener('click', function() {
        imageInput.click();
    });
    
    // Image input change event listener
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                currentImageDataUrl = event.target.result;
                displayImageInChat(currentImageDataUrl);
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Event Listeners for password modal
    restrictedModeCheckbox.addEventListener('change', function() {
        if (this.checked) {
            // Show password modal
            passwordModal.style.display = 'flex';
        }
    });
    
    confirmPasswordBtn.addEventListener('click', function() {
        const password = passwordInput.value;
        if (password === RESTRICTED_MODE_PASSWORD) {
            restrictedModeCheckbox.checked = true;
            passwordModal.style.display = 'none';
            passwordInput.value = '';
            alert('금지모드가 활성화되었습니다.');
        } else {
            alert('잘못된 암호입니다.');
            restrictedModeCheckbox.checked = false;
        }
    });
    
    cancelPasswordBtn.addEventListener('click', function() {
        passwordModal.style.display = 'none';
        restrictedModeCheckbox.checked = false;
        passwordInput.value = '';
    });
    
    generateBtn.addEventListener('click', function() {
        const title = document.getElementById('title').value;
        const description = document.getElementById('name').value;
        const characters = document.getElementById('characters').value;
        const viewpoint = document.getElementById('setting').value;
        const restrictedMode = restrictedModeCheckbox.checked;
        
        if (!title || !description || !characters || !viewpoint) {
            alert('모든 필드를 입력해주세요.');
            return;
        }
        
        // Store characters input for chat functionality
        currentCharacters = characters.split(',').map(char => char.trim());
        
        // Generate novel using GROQ API
        generateNovel(title, description, characters, viewpoint, restrictedMode);
    });
});
